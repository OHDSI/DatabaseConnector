---
title: "Querying a database"
author: "Martijn J. Schuemie"
date: "`r Sys.Date()`"
output:
  pdf_document:
    number_sections: yes
    toc: yes
  html_document:
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Querying a database}
  %\VignetteEncoding{UTF-8}    
---

```{r, echo = FALSE, message = FALSE}
library(DatabaseConnector)
```

# Introduction

This vignette describes how to use the `DatabaseConnector` package to query a database. It assumes you  already know how to create a connection as described in the 'Connecting to a database' vignette.

# Querying

The main functions for querying database are the `DBI::dbGetQuery()` and `DBI::dbExecute()` functions. The difference between these functions is that `DBI::dbGetQuery()` expects data to be returned by the database, and can handle only one SQL statement at a time. In contrast, `DBI::dbExecute()` does not expect data to be returned, and accepts multiple SQL statements in a single SQL string. 

Some examples:

```{r eval=FALSE}
conn <- DBI::dbConnect(DatabaseConnector::DatabaseConnectorDriver(),
                       dbms = "postgresql",
                       server = "localhost/postgres",
                       user = "joe",
                       password = "secret")
```

```{r echo=FALSE}
writeLines("Connecting using PostgreSQL driver")
```

```{r eval=FALSE}
DBI::dbGetQuery(conn, "SELECT TOP 3 * FROM person")
```

```{r echo=FALSE}
data.frame(person_id = c(1,2,3), 
           geneder_concept_id = c(8507, 8507, 8507), 
           year_of_birth = c(1975, 1976, 1977))
```

```{r eval=FALSE}
DBI::dbExecute(conn, "TRUNCATE TABLE foo; DROP TABLE foo; CREATE TABLE foo (bar INT);")
```

Both function provide extensive error reporting: When an error is thrown by the server, the error message and the offending piece of SQL are written to a text file to allow better debugging. The `DBI::dbExecute()` function also by default shows a progress bar, indicating the percentage of SQL statements that has been executed. 

# Inserting tables

Although it is also possible to insert data in the database by sending SQL statements using the `DBI::dbExecute()` function, it is often convenient and faster to use the `DBI::dbWriteTable()` function:

```{r eval=FALSE}
data(mtcars)
DBI::dbWriteTable(conn, name = "mtcars", value = mtcars)
```

In this example, we're uploading the mtcars data frame to a table called 'mtcars' on the server, that will be automatically created.
